shared:
  yarn_caches: &yarn_caches
    cache:
      - docusaurus/node_modules
      - node_modules
      - packages/connect-wallet/node_modules
      - packages/react-tokengating-app/node_modules
      - packages/tokengating-card/node_modules

containers:
  default:
    build:
      from: ubuntu-latest
      type: ci
  publish-container:
    environment: production
    build:
      from: ubuntu-latest
      run:
        - yarn install
        - yarn turbo run build --filter="react-tokengating-app"
        - mkdir -p assets/react-tokengating-app && cp -R packages/react-tokengating-app/dist/index.js assets/react-tokengating-app/index-staging.js
      publish:
        cdn:
          artifacts:
            - path: 'assets'
              patterns: ['*.html', '**/*.js']

steps:
  - <<: *yarn_caches
    label: ':eslint: ESLint'
    timeout: 5m
    run:
      - yarn install
      - yarn lint

  - <<: *yarn_caches
    label: ':typescript: Type checking'
    timeout: 5m
    run:
      - yarn install
      - yarn typecheck

  - <<: *yarn_caches
    label: ':jest: Unit tests'
    timeout: 5m
    run:
      - yarn install
      - yarn test

  - <<: *yarn_caches
    label: 'ðŸ”¨ Build'
    timeout: 5m
    run:
      - yarn install
      - yarn build

  - <<: *yarn_caches
    label: ':storybook: Chromatic'
    timeout: 20m
    git:
      history: true
    run:
      - yarn: ~
      - npx chromatic --auto-accept-changes=main --exit-once-uploaded

  - build: publish-container
    branches: 'staging'
